# Implementation Plan: SDD Command Consolidation

**Branch**: `003-command-consolidation` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-command-consolidation/spec.md`

## Summary

Remove the SDD wrapper commands (`sdd:spec`, `sdd:plan`, `sdd:implement`) and redistribute their discipline logic into trait overlays that augment the base `/speckit.*` commands. Create two new components: `sdd:review-plan` (command + skill for post-planning validation) and `sdd:beads-execute` (skill for beads-driven implementation). Update all retained skills to reference `/speckit.*` instead of removed wrappers.

## Technical Context

**Language/Version**: Bash (POSIX-compatible), Markdown for commands/skills
**Primary Dependencies**: `jq` (JSON parsing), `specify` CLI (spec-kit), `grep`/`rg` (sentinel detection)
**Storage**: JSON (`.specify/sdd-traits.json`), Markdown files
**Testing**: Manual integration testing via `make reinstall` + Claude Code sessions
**Target Platform**: Claude Code plugin (cross-platform via Claude Code CLI)
**Project Type**: Plugin (no compiled source code, all Markdown + Bash)
**Constraints**: Overlay files must be under 20 lines (FR-012), no inlined discipline logic in overlays

## Constitution Check

Validated against `.specify/memory/constitution.md` (v1.1.0). No violations found.

- **II. Overlay Delegation**: All overlays delegate via `{Skill:}`, stay under 20 lines, include sentinel markers. Compliant.
- **III. Trait Composability**: sdd and beads overlays coexist on `speckit.implement` via separate sentinels. Compliant.
- **V. Naming Discipline**: `/speckit.*` prefix and `sdd:` skill prefix used consistently. Compliant.
- **VI. Skill Autonomy**: New skills (review-plan, beads-execute) are self-contained with single purposes. Compliant.

## Project Structure

### Documentation (this feature)

```text
specs/003-command-consolidation/
├── plan.md              # This file
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Requirements checklist
├── review-summary.md    # Generated after tasks.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (plugin directory)

```text
sdd/
├── commands/
│   ├── brainstorm.md          # Retained (FR-003)
│   ├── constitution.md        # Retained (FR-003)
│   ├── evolve.md              # Retained (FR-003)
│   ├── help.md                # Updated (FR-010)
│   ├── init.md                # Retained (FR-003)
│   ├── review-code.md         # Retained (FR-003)
│   ├── review-plan.md         # NEW (FR-013)
│   ├── review-spec.md         # Retained (FR-003)
│   ├── traits.md              # Retained (FR-003)
│   ├── spec.md                # REMOVED (FR-001)
│   ├── plan.md                # REMOVED (FR-001)
│   └── implement.md           # REMOVED (FR-001)
├── skills/
│   ├── brainstorm/SKILL.md         # Updated cross-refs (FR-014)
│   ├── constitution/SKILL.md       # Retained
│   ├── evolve/SKILL.md             # Updated cross-refs (FR-014)
│   ├── help/SKILL.md               # Updated (FR-010)
│   ├── init/SKILL.md               # Retained
│   ├── review-code/SKILL.md        # Updated cross-refs (FR-014)
│   ├── review-plan/SKILL.md        # NEW (FR-013)
│   ├── review-spec/SKILL.md        # Updated cross-refs (FR-014)
│   ├── spec-kit/SKILL.md           # Updated cross-refs (FR-014)
│   ├── spec-refactoring/SKILL.md   # Retained (no changes)
│   ├── using-superpowers-sdd/SKILL.md  # Updated (FR-011)
│   ├── verification-before-completion/SKILL.md  # Updated cross-refs (FR-014)
│   ├── beads-execute/SKILL.md      # NEW (FR-009)
│   ├── spec/SKILL.md               # REMOVED (FR-002)
│   ├── plan/SKILL.md               # REMOVED (FR-002)
│   └── implement/SKILL.md          # REMOVED (FR-002)
├── overlays/
│   ├── sdd/
│   │   └── commands/
│   │       ├── speckit.specify.append.md     # EXISTS (Spec 002)
│   │       ├── speckit.plan.append.md        # NEW (FR-005)
│   │       └── speckit.implement.append.md   # NEW (FR-006)
│   └── beads/
│       ├── commands/
│       │   └── speckit.implement.append.md   # EXISTS (Spec 002)
│       └── templates/
│           └── tasks-template.append.md      # NEW (FR-008)
└── docs/
    └── help.md                # Updated (FR-010)
```

## Implementation Phases

### Phase 1: Create New Overlays (FR-004, FR-005, FR-006, FR-008)

Create the new overlay files that redistribute discipline logic from the removed commands. Each overlay must be under 20 lines and delegate to skills via `{Skill:}`.

**1a. SDD overlay for speckit.plan** (FR-005)
- File: `sdd/overlays/sdd/commands/speckit.plan.append.md`
- Content: Sentinel marker `<!-- SDD-TRAIT:sdd -->`, instruction ordering for pre/post gates
- Pre: "Before generating the plan" invoke `{Skill: sdd:review-spec}`
- Post: "After the plan is generated" run `/speckit.tasks`, then invoke `{Skill: sdd:review-plan}`
- Must stay under 20 lines

**1b. SDD overlay for speckit.implement** (FR-006)
- File: `sdd/overlays/sdd/commands/speckit.implement.append.md`
- Content: Sentinel marker, pre-implementation spec package verification, post-implementation quality gates
- Pre: Verify spec.md, plan.md, tasks.md exist before implementation
- Post: Invoke `{Skill: sdd:review-code}` and `{Skill: sdd:verification-before-completion}`
- Must stay under 20 lines

**1c. Beads overlay for tasks template** (FR-008)
- File: `sdd/overlays/beads/templates/tasks-template.append.md`
- Content: Sentinel marker, beads usage instructions for task management
- Covers: `bd` commands, memory model, discovered work tracking with `bd create`
- Must stay under 20 lines

**1d. Verify existing overlays** (FR-004, FR-007)
- `sdd/overlays/sdd/commands/speckit.specify.append.md` already exists (8 lines, correct)
- `sdd/overlays/beads/commands/speckit.implement.append.md` already exists (10 lines, correct)
- No changes needed for these

### Phase 2: Create New Skills (FR-009, FR-013)

**2a. Create sdd:review-plan skill** (FR-013)
- Command file: `sdd/commands/review-plan.md` (frontmatter + `{Skill: sdd:review-plan}`)
- Skill file: `sdd/skills/review-plan/SKILL.md`
- Extract from current `sdd/skills/plan/SKILL.md` sections 5-8:
  - Section 5 (task quality standards): Actionable, Testable, Atomic, Ordered checks
  - Section 6 (consistency/coverage matrix): Requirement to task to test mapping
  - Section 7 (red flag scan + NFR validation): Vague language, TBD items, NFR measurement
  - Section 8 (review summary generation): `review-summary.md` creation
- Prerequisite check: Both plan.md and tasks.md must exist
- Should use `{Skill: spec-kit}` for initialization

**2b. Create sdd:beads-execute skill** (FR-009)
- Skill file only: `sdd/skills/beads-execute/SKILL.md` (no command file, invoked only via overlay)
- Extract beads-specific execution logic from current `sdd/skills/implement/SKILL.md`:
  - Beads bootstrapping from tasks.md
  - `bd ready --json` loop for dependency-aware task scheduling
  - `bd sync` for git-backed state persistence
  - Discovered work tracking via `bd create`
- Include error handling: if `bd` CLI not available, report and suggest installation

### Phase 3: Remove Old Commands and Skills (FR-001, FR-002)

Remove the wrapper command and skill files. This is straightforward deletion.

**3a. Remove command files** (FR-001)
- Delete: `sdd/commands/spec.md`
- Delete: `sdd/commands/plan.md`
- Delete: `sdd/commands/implement.md`

**3b. Remove skill directories** (FR-002)
- Delete: `sdd/skills/spec/SKILL.md` (and directory)
- Delete: `sdd/skills/plan/SKILL.md` (and directory)
- Delete: `sdd/skills/implement/SKILL.md` (and directory)

### Phase 4: Update Cross-References (FR-014)

Update all retained skills that reference removed commands. Each change is a targeted string replacement.

**Files to update:**

| File | Old Reference | New Reference |
|------|---------------|---------------|
| `skills/brainstorm/SKILL.md` | `sdd:plan` / `sdd:implement` | `/speckit.plan` / `/speckit.implement` |
| `skills/evolve/SKILL.md` | `sdd:spec` | `/speckit.specify` |
| `skills/review-spec/SKILL.md` | `sdd:implement` / `sdd:spec` | `/speckit.implement` / `/speckit.specify` |
| `skills/review-code/SKILL.md` | `sdd:spec` | `/speckit.specify` |
| `skills/verification-before-completion/SKILL.md` | `sdd:implement` / `sdd:spec` | `/speckit.implement` (via sdd trait overlay) / `/speckit.specify` |
| `skills/spec-kit/SKILL.md` | `sdd:spec` / `sdd:implement` / integration points list | `/speckit.specify` / `/speckit.implement` / updated list |
| `skills/help/SKILL.md` | `sdd:implement` | `/speckit.implement` |

### Phase 5: Update Help and Routing (FR-010, FR-011)

**5a. Update help command and skill** (FR-010)
- Update `sdd/commands/help.md`: Adjust description if needed
- Update `sdd/skills/help/SKILL.md`: Replace "Try `/sdd:implement`" references in tutorial next steps
- Update `sdd/docs/help.md`: Rewrite workflow diagram to show:
  - Primary workflow: `/speckit.specify` -> `/speckit.plan` -> `/speckit.implement`
  - SDD helpers: `/sdd:brainstorm`, `/sdd:review-spec`, `/sdd:review-plan`, `/sdd:review-code`, `/sdd:evolve`
  - Configuration: `/sdd:traits`, `/sdd:init`, `/sdd:constitution`
  - Migration note for users upgrading from old command structure
  - Remove the "SDD vs spec-kit" comparison table

**5b. Update routing skill** (FR-011)
- Update `sdd/skills/using-superpowers-sdd/SKILL.md`:
  - Replace `sdd:spec` references with `/speckit.specify`
  - Replace `sdd:plan` references with `/speckit.plan`
  - Replace `sdd:implement` references with `/speckit.implement`
  - Add `sdd:traits` to the skill listing
  - Add `sdd:review-plan` to the skill listing
  - Update the workflow decision tree
  - Remove `sdd:spec-kit` from user-visible listing (it's infrastructure, auto-called)

### Phase 6: Reinstall and Verify

**6a. Reinstall plugin**
- Run `make reinstall` to push changes to plugin cache
- Restart Claude Code

**6b. Verification checklist**
- SC-001: Run `/speckit.specify` with sdd trait enabled, verify review gate fires
- SC-003: Run `/speckit.plan` with sdd trait enabled, verify spec review before planning and review-plan after
- SC-004: Verify removed command files don't exist
- SC-005: Run `/sdd:help`, verify new workflow diagram
- SC-006: Check `using-superpowers-sdd` references
- SC-007: Verify all overlay files are under 20 lines
- SC-009: Run `/sdd:review-plan` independently, verify it works
- SC-010: `rg "sdd:spec|sdd:plan|sdd:implement" sdd/skills/` returns no matches

## File Change Summary

| Action | File | FR |
|--------|------|----|
| CREATE | `sdd/overlays/sdd/commands/speckit.plan.append.md` | FR-005 |
| CREATE | `sdd/overlays/sdd/commands/speckit.implement.append.md` | FR-006 |
| CREATE | `sdd/overlays/beads/templates/tasks-template.append.md` | FR-008 |
| CREATE | `sdd/commands/review-plan.md` | FR-013 |
| CREATE | `sdd/skills/review-plan/SKILL.md` | FR-013 |
| CREATE | `sdd/skills/beads-execute/SKILL.md` | FR-009 |
| DELETE | `sdd/commands/spec.md` | FR-001 |
| DELETE | `sdd/commands/plan.md` | FR-001 |
| DELETE | `sdd/commands/implement.md` | FR-001 |
| DELETE | `sdd/skills/spec/SKILL.md` | FR-002 |
| DELETE | `sdd/skills/plan/SKILL.md` | FR-002 |
| DELETE | `sdd/skills/implement/SKILL.md` | FR-002 |
| UPDATE | `sdd/skills/brainstorm/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/evolve/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/review-spec/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/review-code/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/verification-before-completion/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/spec-kit/SKILL.md` | FR-014 |
| UPDATE | `sdd/skills/help/SKILL.md` | FR-010 |
| UPDATE | `sdd/skills/using-superpowers-sdd/SKILL.md` | FR-011 |
| UPDATE | `sdd/docs/help.md` | FR-010 |

**Totals**: 6 files created, 6 files deleted, 9 files updated

## Complexity Tracking

No constitution violations to justify. The implementation is straightforward: create markdown files following the established overlay pattern, extract skill logic from existing skills, and do targeted string replacements for cross-references.
